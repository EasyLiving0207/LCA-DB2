CREATE OR REPLACE PROCEDURE BG00MAC102.P_ADS_FACT_LCA_SUBCLASS_READ_ENERGY_RESULT_DT(
    IN V_COMPANY_CODE VARCHAR(6),
    IN V_FACTOR_VERSION VARCHAR(100),
    IN V_CERTIFICATION_NUMBER VARCHAR(100)
)
    SPECIFIC P_ADS_FACT_LCA_SUBCLASS_READ_ENERGY_RESULT_DT
    LANGUAGE SQL
    NOT DETERMINISTIC
    EXTERNAL ACTION
    MODIFIES SQL DATA
    CALLED ON NULL INPUT
    INHERIT SPECIAL REGISTERS
    OLD SAVEPOINT LEVEL

BEGIN

    DECLARE V_TMP_SCHEMA VARCHAR(32) DEFAULT 'BG00MAC102';
    DECLARE V_TMP_TAB VARCHAR(50) DEFAULT 'T_ADS_TEMP_LCA_SUBCLASS_CALC_DT';
    DECLARE V_QUERY_STR CLOB(1 M);

    -- Derived helpers
    DECLARE V_UPDATE_SRC VARCHAR(400);

    -- Escape user-provided strings for dynamic SQL safety
    DECLARE V_COMPANY_ESC VARCHAR(200);
    DECLARE V_FACTOR_ESC VARCHAR(400);
    DECLARE V_CERTIFNO_ESC VARCHAR(400);

    SET V_COMPANY_ESC = REPLACE(COALESCE(V_COMPANY_CODE, ''), '''', '''''');
    SET V_FACTOR_ESC = REPLACE(COALESCE(V_FACTOR_VERSION, ''), '''', '''''');
    SET V_CERTIFNO_ESC = REPLACE(COALESCE(V_CERTIFICATION_NUMBER, ''), '''', '''''');
    SET V_UPDATE_SRC = V_TMP_SCHEMA || '.' || V_TMP_TAB || '_DATA';

    -- Non-auto-batch path unchanged, just quote-escaped values
    SET V_QUERY_STR =
            'SELECT * ' ||
            'FROM BG00MAC102.T_ADS_FACT_LCA_MAIN_CAT_EPD_NORM_RESULT_DT ' ||
            'WHERE CERTIFICATION_NUMBER = ''' || V_CERTIFNO_ESC || ''' ' ||
            '  AND COMPANY_CODE = ''' || V_COMPANY_ESC || ''' ' ||
            '  AND FACTOR_VERSION = ''' || V_FACTOR_ESC || ''' ' ||
            '  AND LCI_ELEMENT_CODE IS NOT NULL';

    CALL BG00MAC102.P_CREATE_TEMP_TABLE(
            V_TMP_SCHEMA,
            V_TMP_TAB,
            'ENERGY_RESULT',
            V_QUERY_STR
         );

    SET V_QUERY_STR =
            'SELECT DISTINCT UPDATE_DATE, (SELECT MAX(BATCH_NUMBER) FROM ' || V_TMP_SCHEMA || '.' || V_TMP_TAB ||
            '_ENERGY_RESULT) AS BATCH_NUMBER ' ||
            ' FROM ' || V_UPDATE_SRC || '';

    CALL BG00MAC102.P_CREATE_TEMP_TABLE(
            V_TMP_SCHEMA,
            V_TMP_TAB,
            'DATE_BATCH',
            V_QUERY_STR
         );

END;
